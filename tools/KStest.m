function [KS pval] = KStest(x)
% KStest computes the Kolmogorov-Smirnov test statistic and the corresponding
% p-value. If the sample size is less than and equal 2000, a pre-calculated 
% critical table is employed to return a p-value by interpolation. For
% sampel size greater than 2000, the extrapolation will return a p-value
% with less accuracy.
%
% syntax : [KS pval] = KStest(x)
%
% inputs :
%   x: data , 
%
% outputs :
%   KS :  test statistic. 
%   pval: p-value
%
% created by    Chun-Chao Wang
%               Dept. of Statistics    
%               National Taipei University
%               Taipei, Taiwan
%
% References:
%   Lilliefors, H.W. (1967) "On the Kolmogorov-Smirnov test for normality
%       with mean and variance unknown", Journal of the Amreican Statistical Association, 62, 399-402.

n=length(x);
if n < 4
    error('Sample size must be at least 4.');
end

[Fn, X]=ecdf(x);
F = normcdf(X(2:end), mean(x), std(x));

% test statistic max| Fn - F|
d1= Fn(1:end-1)- F;   
d2= Fn(2:end)- F;   

KS= max(abs([d1 ; d2]));
pval=CVTable(KS,n);

function pval=CVTable(KS, n)
% compute p-value by KS statistic and sample size n

alfa=[0.0010 0.0100 0.0250 0.0500 0.0750 0.1000 0.2000 0.2500 0.5000];
CV=[ ...
     4   0.432725   0.412968   0.395217   0.374815   0.358765   0.344882   0.302724   0.293287   0.258059 ; ...
     5   0.436068   0.395928   0.367048   0.342955   0.329183   0.318946   0.289613   0.277708   0.233466 ; ...
     6   0.421842   0.369970   0.345299   0.323249   0.308077   0.297075   0.268523   0.258397   0.218647 ; ...
     7   0.397025   0.350531   0.325241   0.304223   0.290934   0.280650   0.252548   0.242596   0.206400 ; ...
     8   0.381396   0.333265   0.308560   0.288003   0.275073   0.265108   0.238661   0.229269   0.194922 ; ...
     9   0.364140   0.316968   0.294215   0.274627   0.262048   0.252616   0.227478   0.218415   0.185166 ; ...
    10   0.349444   0.303101   0.280372   0.261966   0.249921   0.240835   0.216963   0.208453   0.176825 ; ...
    11   0.336189   0.290937   0.269626   0.251454   0.240168   0.231485   0.208075   0.199793   0.169506 ; ...
    12   0.326502   0.280615   0.259654   0.242074   0.230895   0.222626   0.200338   0.192463   0.163222 ; ...
    13   0.313390   0.270898   0.250540   0.233672   0.222761   0.214662   0.193073   0.185491   0.157307 ; ...
    14   0.303973   0.262790   0.242896   0.226158   0.215722   0.207746   0.187004   0.179566   0.152364 ; ...
    15   0.295307   0.254441   0.235299   0.219336   0.209199   0.201513   0.181123   0.173977   0.147524 ; ...
    16   0.285736   0.246909   0.228044   0.212228   0.202593   0.195284   0.175867   0.168849   0.143280 ; ...
    17   0.278019   0.240091   0.222045   0.206763   0.197208   0.190001   0.170985   0.164291   0.139419 ; ...
    18   0.274735   0.234436   0.216246   0.201386   0.192115   0.184965   0.166551   0.159985   0.135695 ; ...
    19   0.265775   0.228401   0.211016   0.196559   0.187271   0.180504   0.162485   0.156035   0.132353 ; ...
    20   0.259960   0.223051   0.205862   0.191802   0.182941   0.176352   0.158595   0.152315   0.129380 ; ...
    25   0.234015   0.200813   0.185505   0.172619   0.164614   0.158736   0.142934   0.137299   0.116562 ; ...
    30   0.215238   0.184771   0.170860   0.158766   0.151384   0.145861   0.131293   0.126066   0.107016 ; ...
    35   0.201147   0.171561   0.158416   0.147422   0.140511   0.135413   0.121993   0.117179   0.099488 ; ...
    40   0.188029   0.161238   0.148675   0.138404   0.132052   0.127220   0.114554   0.110014   0.093499 ; ...
    45   0.178784   0.152367   0.140592   0.130842   0.124777   0.120225   0.108196   0.103938   0.088355 ; ...
    50   0.169305   0.145048   0.133627   0.124304   0.118448   0.114209   0.102925   0.098807   0.083971 ; ...
    60   0.155598   0.133035   0.122531   0.114084   0.108754   0.104819   0.094316   0.090553   0.076930 ; ...
    70   0.144072   0.123509   0.113793   0.105961   0.101011   0.097244   0.087493   0.084009   0.071424 ; ...
    80   0.135064   0.115592   0.106585   0.099213   0.094560   0.091143   0.082006   0.078801   0.066982 ; ...
    90   0.128041   0.109262   0.100877   0.093791   0.089428   0.086095   0.077530   0.074459   0.063302 ; ...
   100   0.120970   0.103421   0.095496   0.088860   0.084816   0.081720   0.073601   0.070682   0.060087 ; ...
   125   0.109001   0.092978   0.085648   0.079753   0.076004   0.073227   0.065989   0.063344   0.053896 ; ...
   150   0.099355   0.085042   0.078404   0.072984   0.069655   0.067116   0.060400   0.058004   0.049296 ; ...
   175   0.092600   0.078957   0.072725   0.067578   0.064421   0.062060   0.055879   0.053717   0.045737 ; ...
   200   0.086188   0.073802   0.067979   0.063309   0.060356   0.058155   0.052383   0.050332   0.042877 ; ...
   250   0.077283   0.066092   0.060981   0.056784   0.054129   0.052149   0.046953   0.045120   0.038435 ; ...
   300   0.070573   0.060527   0.055821   0.051904   0.049479   0.047718   0.042937   0.041246   0.035138 ; ...
   400   0.061244   0.052430   0.048402   0.045013   0.042932   0.041364   0.037269   0.035804   0.030480 ; ...
   500   0.054691   0.046907   0.043311   0.040320   0.038441   0.037025   0.033339   0.032049   0.027305 ; ...
   800   0.043390   0.037170   0.034302   0.031902   0.030421   0.029340   0.026441   0.025412   0.021651 ; ...
  1000   0.038819   0.033208   0.030690   0.028593   0.027267   0.026274   0.023652   0.022741   0.019375 ; ...
  1200   0.035349   0.030345   0.028034   0.026124   0.024912   0.024006   0.021616   0.020780   0.017704 ; ...
  1400   0.032984   0.028174   0.025991   0.024188   0.023055   0.022218   0.020022   0.019243   0.016398 ; ...
  1600   0.030889   0.026375   0.024300   0.022613   0.021548   0.020777   0.018727   0.017997   0.015337 ; ...
  1800   0.028845   0.024769   0.022901   0.021338   0.020354   0.019611   0.017672   0.016985   0.014477 ; ...
  2000   0.027632   0.023542   0.021770   0.020269   0.019313   0.018629   0.016803   0.016136   0.013754 ];

% pchip performs better than spline here
cvs = pchip(CV(:,1),CV(:,2:end)',n);% interpolate samples 
pp=pchip(alfa, cvs);
if KS < cvs(end)
    pval=alfa(end);
elseif KS > cvs(1)
    pval=alfa(1);
else
    i = find(KS > cvs, 1, 'first');
    pval = fzero(@(x) ppval(pp,x)-KS,alfa([i-1 i]));% be cautious with fzero
end